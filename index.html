<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>네트급여/최저임금·근무시간별 급여 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background:#f3f4f6 }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; }
    .table-wrap { overflow-x:auto }
    .th, .td { white-space:nowrap }
  </style>
</head>
<body class="p-4 sm:p-6 flex items-center justify-center min-h-screen">

  <!-- 메인 컨테이너 -->
  <main class="w-full max-w-[1280px] xl:max-w-[1400px]">

    <!-- 상단: 제목 -->
    <section class="card p-5 sm:p-7 mb-4">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-3xl sm:text-[2rem] font-extrabold leading-tight text-gray-900">
          네트급여 계산기 + 최저임금/근무시간별 급여액 계산
        </h1>
        <button id="ver_btn" type="button" class="text-blue-600 font-semibold hover:text-blue-800 underline">Ver 2.0</button>
      </div>
    </section>

    <!-- ▶ 최저임금/근무시간별 급여액 계산 섹션 -->
    <section class="card p-5 sm:p-7 mb-5">
      <h2 class="text-xl font-bold text-gray-900 mb-4">최저임금계산 · 근무시간별 급여액 계산</h2>

      <!-- 상단 설정 -->
      <div class="grid sm:grid-cols-3 gap-3 mb-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">연도</label>
          <input id="mw_year" type="number" class="w-full px-3 py-2 border rounded-lg" value="2025">
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">최저시급(원)</label>
          <input id="min_wage" type="text" inputmode="numeric" class="w-full px-3 py-2 border rounded-lg" value="10,030">
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">계약시급(원)</label>
          <input id="contract_wage" type="text" inputmode="numeric" class="w-full px-3 py-2 border rounded-lg" value="15,000">
        </div>
      </div>

      <p class="text-sm text-gray-600 mb-3">
        사용방법) 요일별 근무시간을 입력하면 <b>주휴시간</b>, <b>주소정근로시간</b>, <b>월소정근로시간</b>이 자동 계산되고,
        해당 시간으로 <b>최저급여</b>와 <b>계약급여</b>의 <b>세전/실수령</b> 및
        <b>계약급여(실수령 기준 역산 세전)</b>까지 표기됩니다.
      </p>

      <!-- 입력그리드(10안) -->
      <div id="mw_rows" class="space-y-3 mb-4"></div>

      <div class="flex items-center gap-2 mb-2">
        <button id="mw_add" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg border">+ 행 추가</button>
        <button id="mw_calc" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">계산</button>
        <span id="mw_status" class="text-[11px] text-gray-500 ml-auto">세액표 상태: 로딩 중…</span>
      </div>

      <!-- 결과표 래퍼 -->
      <div class="table-wrap border rounded-xl">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-700">
            <tr>
              <th class="th p-2 border-b text-center">구분</th>
              <th class="th p-2 border-b text-center">월</th>
              <th class="th p-2 border-b text-center">화</th>
              <th class="th p-2 border-b text-center">수</th>
              <th class="th p-2 border-b text-center">목</th>
              <th class="th p-2 border-b text-center">금</th>
              <th class="th p-2 border-b text-center">토</th>
              <th class="th p-2 border-b text-center">일</th>
              <th class="th p-2 border-b text-center">주휴시간</th>
              <th class="th p-2 border-b text-center">주소정근로시간</th>
              <th class="th p-2 border-b text-center">월소정근로시간</th>
              <th class="th p-2 border-b text-right">최저급여(세전)</th>
              <th class="th p-2 border-b text-right">최저급여(실수령)</th>
              <th class="th p-2 border-b text-right">계약급여(세전)</th>
              <th class="th p-2 border-b text-right">계약급여(실수령)</th>
              <th class="th p-2 border-b text-right">계약급여(실수령→역산 세전)</th>
            </tr>
          </thead>
          <tbody id="mw_tbody" class="text-gray-800"></tbody>
        </table>
      </div>

      <p class="text-[11px] text-gray-500 mt-2">
        ※ 주휴시간은 주당 근로시간이 15시간 이상인 경우에 한해 <b>주당 총 근로시간 ÷ 근무일수</b>로 산출합니다.
        월소정근로시간은 <b>주소정근로시간 × (365/7/12)</b>를 반올림하여 계산합니다(예: 48h → 209h).
      </p>
    </section>

    <!-- ▼ 기존 네트급여 계산기 (요청하신 디자인/로직 유지) -->
    <section class="card p-6">
      <!-- 탭 -->
      <div class="flex items-center justify-center gap-4 mb-4 border-b pb-2">
        <button id="tab_single" type="button"
          class="px-4 py-2 text-sm font-semibold border-b-2 transition-colors
                 text-blue-600 font-bold border-blue-600 hover:text-blue-700">단일</button>
        <button id="tab_multi" type="button"
          class="px-4 py-2 text-sm font-semibold border-b-2 transition-colors
                 text-gray-500 border-transparent hover:text-blue-600">다중</button>
        <span class="ml-auto text-xs text-gray-500"></span>
      </div>

      <!-- 단일 -->
      <div id="content_single">
        <div class="bg-white rounded-2xl p-6 md:p-8 border">
          <!-- 입력 -->
          <div class="mb-3">
            <label class="block text-gray-700 font-semibold mb-2">실수령액 (원)</label>
            <input id="net_pay" type="text" inputmode="numeric"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="예: 11,350,000">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">비과세 합계(월) — 식대/자가운전 등 (원)</label>
            <input id="nontax" type="text" inputmode="numeric"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="예: 200,000 (없으면 0)">
            <p id="table_status" class="text-[11px] text-gray-400 mt-1">세액표 불러오는 중…</p>
          </div>

          <button id="calc_btn"
                  class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-0 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>계산하기</button>

          <!-- 결과 -->
          <div id="result" class="bg-gray-50 rounded-lg p-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">계산 결과</h2>

            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-600">지급총액</div>
                <div id="gross_pay_result" class="font-semibold text-gray-900 mt-1"></div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-600">공제액 합계</div>
                <div id="deductions_total_result" class="font-semibold text-gray-900 mt-1"></div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">연봉(퇴직금 제외)</div>
                <div id="annual_excl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">(= 지급총액 × 12)</div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">연봉(퇴직금 포함)</div>
                <div id="annual_incl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">(= 지급총액 × 13)</div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">총부담액(퇴직금 제외)</div>
                <div id="total_burden_excl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">실수령액 대비 <span id="total_burden_excl_pct"></span></div>
              </div>
              <div class="bg-white rounded-lg border p-3">
                <div class="text-gray-700 font-medium">총부담액(퇴직금 포함)</div>
                <div id="total_burden_incl" class="font-semibold text-gray-900 mt-1"></div>
                <div class="text-[11px] text-gray-500 mt-1">실수령액 대비 <span id="total_burden_incl_pct"></span></div>
              </div>
            </div>

            <!-- 수식형 요약 -->
            <div class="mt-6 space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-700">+ 4대보험 총액(근로자+사업주)</span>
                <span id="social_total_summary" class="font-semibold text-gray-900"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">+ 원천세 총액(소득세+지방소득세)</span>
                <span id="withholding_total_summary" class="font-semibold text-gray-900"></span>
              </div>
              <div class="border-t border-gray-300 my-1"></div>
              <div class="flex justify-between">
                <span class="text-gray-700">= 부대비용 총액(퇴직금 제외)</span>
                <span id="overhead_excl_gratuity" class="font-semibold text-gray-900"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">+ 퇴직금 (지급총액의 1/12)</span>
                <span id="gratuity_summary" class="font-semibold text-gray-900"></span>
              </div>
              <div class="border-t border-gray-300 my-1"></div>
              <div class="flex justify-between">
                <span class="text-gray-700">= 부대비용 총액(퇴직금 포함)</span>
                <span id="overhead_incl_gratuity" class="font-semibold text-gray-900"></span>
              </div>
            </div>

            <!-- 세부 공제 내역 -->
            <div class="mt-6">
              <h3 class="text-lg font-bold text-gray-700 mb-2">세부 공제 내역</h3>
              <ul class="text-sm text-gray-600 space-y-1">
                <li class="flex justify-between"><span>국민연금 (4.5%)</span><span id="np_deduction"></span></li>
                <li class="flex justify-between"><span>건강보험 (3.545%)</span><span id="hi_deduction"></span></li>
                <li class="flex justify-between"><span>장기요양 (건보료의 12.95%)</span><span id="ltc_deduction"></span></li>
                <li class="flex justify-between"><span>고용보험 (0.9%)</span><span id="ei_deduction"></span></li>
                <li class="flex justify-between"><span>소득세 (간이세액표)</span><span id="tax_deduction"></span></li>
                <li class="flex justify-between"><span>지방소득세 (10%)</span><span id="local_tax_deduction"></span></li>
              </ul>

              <!-- 사업주 부담분(세부) -->
              <div class="mt-6 border-t pt-4">
                <h4 class="text-base font-bold text-gray-700 mb-2">사업주 부담분</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                  <li class="flex justify-between"><span>국민연금 (4.5%)</span><span id="np_er"></span></li>
                  <li class="flex justify-between"><span>건강보험 (3.545%)</span><span id="hi_er"></span></li>
                  <li class="flex justify-between"><span>장기요양 (건보료의 12.95%)</span><span id="ltc_er"></span></li>
                  <li class="flex justify-between"><span>고용보험 (1.15%)</span><span id="ei_er"></span></li>
                  <li class="flex justify-between"><span>산재보험 (0.72%)</span><span id="wci_er"></span></li>
                  <li class="flex justify-between font-semibold pt-1"><span>4대보험 사업주 부담분</span><span id="er_total"></span></li>
                </ul>

                <details class="mt-4 text-[11px] text-gray-500">
                  <summary class="cursor-pointer">기준 금액(보수월액/세액표 기준) 보기</summary>
                  <div class="mt-2 space-y-1">
                    <div class="flex justify-between"><span>보수월액(비과세 제외)</span><span id="base_ins"></span></div>
                    <div class="flex justify-between"><span>국민연금 기준소득(천원단위·상·하한)</span><span id="base_np"></span></div>
                    <div class="flex justify-between"><span>건강보험 산정기준(상·하한)</span><span id="base_hi"></span></div>
                    <div class="flex justify-between"><span>고용보험 산정기준</span><span id="base_ei"></span></div>
                    <div class="flex justify-between"><span>간이세액표 기준금액</span><span id="base_tax"></span></div>
                  </div>
                </details>
              </div>
            </div>
          </div>

          <div id="error_message" class="text-center text-red-500 mt-4 hidden">유효한 금액을 입력해 주세요.</div>
        </div>
      </div>

      <!-- 다중 -->
      <div id="content_multi" class="hidden">
        <div class="bg-white rounded-2xl p-6 md:p-8 border">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-gray-600">여러 개의 실수령액/비과세 금액을 입력하여 요약 결과를 한 번에 확인하세요.</div>
            <div class="flex gap-2">
              <button id="add_row" class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg border">+ 행 추가</button>
              <button id="calc_multi" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">다중 계산</button>
            </div>
          </div>

          <div id="multi_inputs" class="space-y-2"></div>

          <div class="overflow-x-auto xl:overflow-visible mt-4">
            <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden min-w-[1100px] xl:min-w-0">
              <thead class="bg-gray-50 text-gray-700">
                <tr>
                  <th class="p-2 border-b text-right whitespace-nowrap">실수령액</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">비과세</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">지급총액</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">공제합계</th>
                  <th class="p-2 border-b text-right whitespace-nowrap">연봉 <span class="text-xs text-gray-500">(퇴직금제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">연봉 <span class="text-xs text-gray-500">(퇴직금포함)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담 <span class="text-xs text-gray-500">(퇴직금제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담% <span class="text-xs text-gray-500">(제외)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담 <span class="text-xs text-gray-500">(퇴직금포함)</span></th>
                  <th class="p-2 border-b text-right whitespace-nowrap">총부담% <span class="text-xs text-gray-500">(포함)</span></th>
                </tr>
              </thead>
              <tbody id="multi_results" class="text-gray-800"></tbody>
            </table>
          </div>

          <p id="table_status_multi" class="text-[11px] text-gray-400 mt-2">세액표 준비 상태: 로딩 중…</p>
        </div>
      </div>
    </section>

    <!-- 푸터 위 배너 (원문 동일) -->
    <div class="px-4 sm:px-5 my-5">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a href="https://www.kdrcash.kr/download" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EB%8B%A5%ED%84%B0%EC%BA%90%EC%8B%9C%20%EB%8B%A4%EC%9A%B4%EB%A1%9C%EB%93%9C.png?raw=true"
                 alt="다운로드"
                 class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
        <a href="https://www.kdrcash.kr/survey" target="_blank" rel="noopener noreferrer" class="block group">
          <div class="relative w-full aspect-[4/1] rounded-xl overflow-hidden border border-gray-200 shadow-sm">
            <img src="https://github.com/kdrcash/pay/blob/main/%EA%B0%9C%EC%9B%90%EA%B4%80%EB%A0%A8%20%ED%95%84%EC%88%98%EC%9E%90%EB%A3%8C%20%EB%AA%A8%EC%9D%8C.png?raw=true"
                 alt="개원 필수자료 모음"
                 class="absolute inset-0 w-full h-full object-cover transition duration-200 group-hover:opacity-90">
          </div>
        </a>
      </div>
    </div>

    <!-- 푸터 -->
    <section class="card p-4 text-center mt-4">
      <footer class="text-xs text-gray-500">© 2024 한국병의원데이터. All Rights Reserved</footer>
    </section>
  </main>

  <!-- Ver 2.0 규칙 모달 -->
  <div id="ver_modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div role="dialog" aria-modal="true"
         class="relative w-full max-w-md mx-4 bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-bold text-gray-800">버전 2.0 • 계산 규칙</h3>
        <button id="ver_close"
                class="p-2 -m-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="닫기">✕</button>
      </div>

      <div class="text-sm text-gray-700 space-y-4">
        <div>
          <h4 class="font-semibold text-gray-900 mb-1">적용 규칙</h4>
          <ul class="list-disc pl-5 space-y-1">
            <li>2024 간이세액표(1인) 적용</li>
            <li>4대보험 상·하한 반영</li>
            <li>장기요양보험료 = 건강보험료 × <b>12.95%</b></li>
            <li>모든 세목·보험 <b>10원 절사</b></li>
            <li>세목·보험 산정 기준: <b>비과세 제외 금액</b></li>
            <li>국민연금 기준소득: <b>천원단위</b>로 내림</li>
          </ul>
        </div>

        <div>
          <h4 class="font-semibold text-gray-900 mb-2">상·하한 | 면세 기준 (현재 계산식 사용값)</h4>
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-3 space-y-1 text-[13px]">
            <div class="flex justify-between"><span>국민연금 기준소득월액 하한</span><span id="np_min_label"></span></div>
            <div class="flex justify-between"><span>국민연금 기준소득월액 상한</span><span id="np_max_label"></span></div>
            <div class="flex justify-between"><span>건강보험 보수월액 하한</span><span id="hi_min_label"></span></div>
            <div class="flex justify-between"><span>건강보험 보수월액 상한</span><span id="hi_max_label"></span></div>
            <div class="flex justify-between font-semibold">
              <span>소득세 면세 기준</span>
              <span id="tax_zero_label"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-5 flex justify-end">
        <button id="ver_ok"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">확인</button>
      </div>
    </div>
  </div>

  <!-- 스크립트 -->
  <script>
    /* ===== 유틸 ===== */
    function fmt(n){ return new Intl.NumberFormat('ko-KR').format(Math.round(n))+' 원'; }
    const fmtPct = n => new Intl.NumberFormat('ko-KR',{minimumFractionDigits:1,maximumFractionDigits:1}).format(n)+' %';
    const onlyNum = v => parseFloat((v||'').toString().replace(/[^\d]/g,''))||0;
    const num = el => onlyNum(el.value);
    const trunc10 = v => Math.floor(v/10)*10;
    const clamp = (x,lo,hi)=>Math.min(Math.max(x,lo),hi);
    const bindComma = el => el.addEventListener('input', e => {
      const d = e.target.value.replace(/[^\d]/g,'');
      e.target.value = d ? new Intl.NumberFormat('ko-KR').format(+d) : '';
    });

    /* ===== 탭 토글 ===== */
    const tabSingleBtn = document.getElementById('tab_single');
    const tabMultiBtn  = document.getElementById('tab_multi');
    const contentSingle= document.getElementById('content_single');
    const contentMulti = document.getElementById('content_multi');
    const ACTIVE = ['text-blue-600','font-bold','border-blue-600'];
    const INACTIVE = ['text-gray-500','border-transparent'];
    function setActive(btnActive, btnInactive, show, hide){
      btnActive.classList.add(...ACTIVE); btnActive.classList.remove(...INACTIVE);
      btnInactive.classList.add(...INACTIVE); btnInactive.classList.remove(...ACTIVE);
      show.classList.remove('hidden'); hide.classList.add('hidden');
    }
    tabSingleBtn.addEventListener('click', ()=>setActive(tabSingleBtn, tabMultiBtn, contentSingle, contentMulti));
    tabMultiBtn.addEventListener('click',  ()=>setActive(tabMultiBtn, tabSingleBtn, contentMulti, contentSingle));
    setActive(tabSingleBtn, tabMultiBtn, contentSingle, contentMulti);

    /* ===== 파라미터(보험/세액표) ===== */
    const NP_MIN=400_000, NP_MAX=6_370_000;            // 국민연금 기준소득 하·상한
    const HI_MIN=279_266, HI_MAX=127_056_982;          // 건강보험 보수월액 하·상한
    const NP_RATE=0.0450, HI_RATE=0.03545, LTC_RATE=0.1295, EI_RATE=0.0090;
    const NP_ER_RATE=0.0450, HI_ER_RATE=0.03545, LTC_ER_RATE=0.1295, EI_ER_RATE=0.0115, WCI_ER_RATE=0.0072;
    const BASE10_1PERSON_RAW=1_507_405; // (fallback 근사용)
    const TAX_ZERO_THRESHOLD = 1_060_000;

    /* ===== 모달 ===== */
    const verBtn = document.getElementById('ver_btn');
    const verModal = document.getElementById('ver_modal');
    const verClose = document.getElementById('ver_close');
    const verOk = document.getElementById('ver_ok');
    function fillVerModalBounds(){
      document.getElementById('np_min_label').textContent = fmt(NP_MIN);
      document.getElementById('np_max_label').textContent = fmt(NP_MAX);
      document.getElementById('hi_min_label').textContent = fmt(HI_MIN);
      document.getElementById('hi_max_label').textContent = fmt(HI_MAX);
      document.getElementById('tax_zero_label').textContent = fmt(TAX_ZERO_THRESHOLD);
    }
    function openVerModal(){ fillVerModalBounds(); verModal.classList.remove('hidden'); verModal.classList.add('flex'); document.body.classList.add('overflow-hidden'); }
    function closeVerModal(){ verModal.classList.add('hidden'); verModal.classList.remove('flex'); document.body.classList.remove('overflow-hidden'); }
    verBtn.addEventListener('click', openVerModal);
    verClose.addEventListener('click', closeVerModal);
    verOk.addEventListener('click', closeVerModal);
    verModal.addEventListener('click', (e)=>{ const dialog=e.currentTarget.querySelector('[role="dialog"]'); if(!dialog.contains(e.target)) closeVerModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeVerModal(); });

    /* ===== 세액표 로딩 ===== */
    let TAX_TABLE=[], tableReady=false;
    const statusEl=document.getElementById('table_status');
    const statusElMulti=document.getElementById('table_status_multi');
    const mwStatus=document.getElementById('mw_status');
    async function loadTax(){
      async function tryFetch(path){
        const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
      }
      try{
        try { TAX_TABLE = await tryFetch('./simplified_tax_table_2024_1person.v2.json'); }
        catch { TAX_TABLE = await tryFetch('./simplified_tax_table_2024_1person.json'); }
        TAX_TABLE.sort((a,b)=>a.min_won-b.min_won);
        tableReady=true;
        if(statusEl) statusEl.textContent='세액표 로드 완료';
        if(statusElMulti) statusElMulti.textContent='세액표 준비 상태: 로드 완료';
        if(mwStatus) mwStatus.textContent='세액표 상태: 로드 완료';
        document.getElementById('calc_btn').disabled=false;
      }catch(e){
        if(statusEl) statusEl.textContent='세액표 로드 실패: '+e.message;
        if(statusElMulti) statusElMulti.textContent='세액표 로드 실패: '+e.message;
        if(mwStatus) mwStatus.textContent='세액표 로드 실패: '+e.message;
      }
    }
    loadTax();

    function lookupTable(x){
      let lo=0,hi=TAX_TABLE.length-1;
      while(lo<=hi){
        const m=(lo+hi)>>1,row=TAX_TABLE[m];
        if(x<row.min_won) hi=m-1; else if(x>=row.max_won) lo=m+1;
        else return {found:true,tax:+row.tax||0};
      }
      return {found:false,tax:0};
    }

    function simplifiedTax(amountExclNT){
      const r=lookupTable(amountExclNT);
      if(r.found) return trunc10(r.tax);
      // 보간/근사 (테이블 범위 밖일 때 안전장치)
      const g=amountExclNT, b10=BASE10_1PERSON_RAW; let t=b10;
      if(g>10_000_000&&g<=14_000_000) t += 25_000 + 0.35*0.98*(g-10_000_000);
      else if(g>14_000_000&&g<=28_000_000) t += 1_397_000 + 0.38*0.98*(g-14_000_000);
      else if(g>28_000_000&&g<=30_000_000) t += 6_610_600 + 0.40*0.98*(g-28_000_000);
      else if(g>30_000_000&&g<=45_000_000) t += 7_394_600 + 0.40*(g-30_000_000);
      else if(g>45_000_000&&g<=87_000_000) t += 13_394_600 + 0.42*(g-45_000_000);
      else if(g>87_000_000)               t += 31_034_600 + 0.45*(g-87_000_000);
      return trunc10(t);
    }

    /* ===== 공제 계산(정방향 & 역산) ===== */
    // (A) net → gross 역산(기존)
    function computeFromNet(netPay, nonTax){
      if(!tableReady || netPay<=0){ return null; }
      let approx = NP_RATE + HI_RATE + (HI_RATE*LTC_RATE) + EI_RATE;
      let gross = netPay / (1 - approx);
      for(let i=0;i<160;i++){
        const baseIns = Math.max(gross - nonTax, 0);
        const npBaseRaw = Math.floor(baseIns/1000)*1000;
        const baseNP = clamp(npBaseRaw, NP_MIN, NP_MAX);
        const baseHI = clamp(baseIns, HI_MIN, HI_MAX);
        const baseEI = baseIns;

        const np  = trunc10(baseNP * NP_RATE);
        const hi  = trunc10(baseHI * HI_RATE);
        const ltc = trunc10(hi * LTC_RATE);
        const ei  = trunc10(baseEI * EI_RATE);

        const tax  = baseIns < TAX_ZERO_THRESHOLD ? 0 : trunc10(simplifiedTax(baseIns));
        const ltax = baseIns < TAX_ZERO_THRESHOLD ? 0 : trunc10(tax * 0.1);

        const total = np + hi + ltc + ei + tax + ltax;
        const newGross = netPay + total;
        if (Math.abs(newGross - gross) < 1) { gross = newGross; break; }
        gross = newGross;
      }
      return finalizeCalc(gross, nonTax);
    }

    // (B) gross → net 정방향
    function computeFromGross(gross, nonTax){
      if(!tableReady || gross<=0){ return null; }
      return finalizeCalc(gross, nonTax);
    }

    // 공통 마감
    function finalizeCalc(gross, nonTax){
      const baseIns = Math.max(gross - nonTax, 0);
      const npBaseRaw = Math.floor(baseIns/1000)*1000;
      const baseNP = clamp(npBaseRaw, NP_MIN, NP_MAX);
      const baseHI = clamp(baseIns, HI_MIN, HI_MAX);
      const baseEI = baseIns;

      const np  = trunc10(baseNP * NP_RATE);
      const hi  = trunc10(baseHI * HI_RATE);
      const ltc = trunc10(hi * LTC_RATE);
      const ei  = trunc10(baseEI * EI_RATE);

      const tax  = baseIns < TAX_ZERO_THRESHOLD ? 0 : trunc10(simplifiedTax(baseIns));
      const ltax = baseIns < TAX_ZERO_THRESHOLD ? 0 : trunc10(tax * 0.1);

      const total = np + hi + ltc + ei + tax + ltax;
      const net = gross - total;

      const np_er  = trunc10(baseNP * NP_ER_RATE);
      const hi_er  = trunc10(baseHI * HI_ER_RATE);
      const ltc_er = trunc10(hi_er * LTC_ER_RATE);
      const ei_er  = trunc10(baseEI * EI_ER_RATE);
      const wci_er = trunc10(baseEI * WCI_ER_RATE);
      const er_total = np_er + hi_er + ltc_er + ei_er + wci_er;

      const social_total = (np + hi + ltc + ei) + er_total;
      const withholding_total = tax + ltax;
      const gratuity = Math.round(gross / 12);
      const overhead_excl = social_total + withholding_total;
      const overhead_incl = overhead_excl + gratuity;

      const total_burden_excl = net + overhead_excl;
      const total_burden_incl = net + overhead_incl;

      const annual_excl = Math.round(gross * 12);
      const annual_incl = Math.round(gross * 13);

      return {
        gross, net, total, annual_excl, annual_incl,
        social_total, withholding_total,
        overhead_excl, overhead_incl,
        gratuity,
        total_burden_excl, total_burden_incl,
        // 세부 공제(근로자)
        np, hi, ltc, ei, tax, ltax,
        // 사업주 부담
        np_er, hi_er, ltc_er, ei_er, wci_er, er_total,
        // 기준 금액
        baseIns, baseNP, baseHI, baseEI, baseTax: baseIns
      };
    }

    /* ===== 단일 계산 버튼 ===== */
    const netInput = document.getElementById('net_pay');
    const nonTaxInput = document.getElementById('nontax');
    bindComma(netInput); bindComma(nonTaxInput);

    document.getElementById('calc_btn').addEventListener('click', ()=>{
      if(!tableReady){ if(statusEl) statusEl.textContent='세액표가 아직 준비되지 않았습니다.'; return; }
      const netPay=num(netInput), nonTax=num(nonTaxInput);
      if(netPay<=0){
        document.getElementById('result').classList.add('hidden');
        document.getElementById('error_message').classList.remove('hidden');
        return;
      }
      const r=computeFromNet(netPay, nonTax);
      if(!r){ return; }

      const excl_pct = (r.total_burden_excl / netPay) * 100;
      const incl_pct = (r.total_burden_incl / netPay) * 100;

      document.getElementById('social_total_summary').textContent    = fmt(r.social_total);
      document.getElementById('withholding_total_summary').textContent = fmt(r.withholding_total);
      document.getElementById('overhead_excl_gratuity').textContent = fmt(r.overhead_excl);
      document.getElementById('gratuity_summary').textContent       = fmt(r.gratuity);
      document.getElementById('overhead_incl_gratuity').textContent = fmt(r.overhead_incl);

      document.getElementById('total_burden_excl').textContent = fmt(r.total_burden_excl);
      document.getElementById('total_burden_incl').textContent = fmt(r.total_burden_incl);
      document.getElementById('total_burden_excl_pct').textContent = fmtPct(excl_pct);
      document.getElementById('total_burden_incl_pct').textContent = fmtPct(incl_pct);

      document.getElementById('annual_excl').textContent = fmt(r.annual_excl);
      document.getElementById('annual_incl').textContent = fmt(r.annual_incl);

      document.getElementById('gross_pay_result').textContent        = fmt(r.gross);
      document.getElementById('deductions_total_result').textContent = fmt(r.total);

      document.getElementById('np_deduction').textContent     = fmt(r.np);
      document.getElementById('hi_deduction').textContent     = fmt(r.hi);
      document.getElementById('ltc_deduction').textContent    = fmt(r.ltc);
      document.getElementById('ei_deduction').textContent     = fmt(r.ei);
      document.getElementById('tax_deduction').textContent    = fmt(r.tax);
      document.getElementById('local_tax_deduction').textContent = fmt(r.ltax);

      document.getElementById('np_er').textContent   = fmt(r.np_er);
      document.getElementById('hi_er').textContent   = fmt(r.hi_er);
      document.getElementById('ltc_er').textContent  = fmt(r.ltc_er);
      document.getElementById('ei_er').textContent   = fmt(r.ei_er);
      document.getElementById('wci_er').textContent  = fmt(r.wci_er);
      document.getElementById('er_total').textContent= fmt(r.er_total);

      document.getElementById('base_ins').textContent = fmt(r.baseIns);
      document.getElementById('base_np').textContent  = fmt(r.baseNP);
      document.getElementById('base_hi').textContent  = fmt(r.baseHI);
      document.getElementById('base_ei').textContent  = fmt(r.baseEI);
      document.getElementById('base_tax').textContent = fmt(r.baseTax);

      document.getElementById('error_message').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');
    });

    /* ===== 다중 계산식 ===== */
    const multiInputs = document.getElementById('multi_inputs');
    const multiResults = document.getElementById('multi_results');
    const addRowBtn = document.getElementById('add_row');
    const calcMultiBtn = document.getElementById('calc_multi');
    function createRow(initialNet='', initialNT=''){
      const row = document.createElement('div');
      row.className='flex flex-col sm:flex-row gap-2';
      row.innerHTML = `
        <input type="text" inputmode="numeric" placeholder="실수령액"
               class="net-input w-full sm:w-64 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               value="${initialNet}">
        <input type="text" inputmode="numeric" placeholder="비과세 합계(없으면 0)"
               class="nontax-input w-full sm:w-64 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               value="${initialNT}">
        <button type="button" class="remove-row px-3 py-2 text-sm rounded-lg border hover:bg-gray-100">삭제</button>
      `;
      multiInputs.appendChild(row);
      const netEl=row.querySelector('.net-input');
      const ntEl=row.querySelector('.nontax-input');
      bindComma(netEl); bindComma(ntEl);
      row.querySelector('.remove-row').addEventListener('click', ()=>{ row.remove(); });
    }
    createRow(); createRow();
    addRowBtn.addEventListener('click', ()=>createRow());

    calcMultiBtn.addEventListener('click', ()=>{
      if(!tableReady){ if(statusElMulti) statusElMulti.textContent='세액표가 아직 준비되지 않았습니다.'; return; }
      multiResults.innerHTML='';
      const rows = Array.from(multiInputs.children);
      rows.forEach(r=>{
        const netEl=r.querySelector('.net-input');
        const ntEl=r.querySelector('.nontax-input');
        const netPay = onlyNum(netEl.value);
        const nonTax = onlyNum(ntEl.value);
        if(netPay<=0){ return; }
        const res = computeFromNet(netPay, nonTax);
        if(!res){ return; }
        const exclPct = (res.total_burden_excl/netPay)*100;
        const inclPct = (res.total_burden_incl/netPay)*100;
        const tr = document.createElement('tr');
        tr.className='border-t';
        tr.innerHTML = `
          <td class="p-2 whitespace-nowrap text-right">${fmt(netPay)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(nonTax)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(res.gross)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(res.total)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(res.annual_excl)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(res.annual_incl)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(res.total_burden_excl)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmtPct(exclPct)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmt(res.total_burden_incl)}</td>
          <td class="p-2 whitespace-nowrap text-right">${fmtPct(inclPct)}</td>
        `;
        multiResults.appendChild(tr);
      });
      if(!multiResults.children.length){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="10" class="p-3 text-center text-gray-500 whitespace-nowrap">유효한 입력이 없습니다.</td>`;
        multiResults.appendChild(tr);
      }
    });

    /* ===== 최저임금/근무시간별 표 ===== */
    const mwRows = document.getElementById('mw_rows');
    const mwAdd = document.getElementById('mw_add');
    const mwCalc = document.getElementById('mw_calc');
    const mwTbody = document.getElementById('mw_tbody');
    const minWageEl=document.getElementById('min_wage');
    const contractWageEl=document.getElementById('contract_wage');
    bindComma(minWageEl); bindComma(contractWageEl);

    function rowTemplate(idx){
      return `
        <div class="grid grid-cols-8 sm:grid-cols-10 gap-2 items-end">
          <div class="col-span-8 sm:col-span-10 text-sm font-semibold text-gray-700">근로시간 ${idx+1}안</div>
          ${['월','화','수','목','금','토','일'].map((d,i)=>`
            <div>
              <label class="block text-[11px] text-gray-500 mb-1">${d}</label>
              <input type="number" step="0.1" min="0" class="dayh w-full px-2 py-1.5 border rounded-lg text-right" value="${i<5?8:0}">
            </div>
          `).join('')}
        </div>
      `;
    }
    function addMwRow(){ const wrap=document.createElement('div'); wrap.className='p-3 border rounded-xl bg-white'; wrap.innerHTML=rowTemplate(document.querySelectorAll('#mw_rows .p-3').length); mwRows.appendChild(wrap); }
    for(let i=0;i<10;i++) addMwRow();
    mwAdd.addEventListener('click', addMwRow);

    function weeklyCalc(dayHours){
      const workdays = dayHours.filter(h=>h>0.0001).length;
      const weeklyHours = dayHours.reduce((a,b)=>a+b,0);
      const restEligible = weeklyHours>=15 && workdays>0;
      const weeklyHoliday = restEligible ? (weeklyHours / workdays) : 0;
      const weeklyStd = weeklyHours + weeklyHoliday;
      const monthlyStd = Math.round(weeklyStd * (365/7/12)); // 반올림
      return { workdays, weeklyHours, weeklyHoliday, weeklyStd, monthlyStd };
    }

    function buildCell(v){ return `<td class="td p-2 border-t text-right">${v}</td>`; }
    function buildCellC(v){ return `<td class="td p-2 border-t text-center">${v}</td>`; }

    mwCalc.addEventListener('click', ()=>{
      if(!tableReady){ if(mwStatus) mwStatus.textContent='세액표가 아직 준비되지 않았습니다.'; return; }
      mwTbody.innerHTML='';
      const minWage = onlyNum(minWageEl.value);
      const contractWage = onlyNum(contractWageEl.value);

      document.querySelectorAll('#mw_rows .p-3').forEach((block,idx)=>{
        const inputs=[...block.querySelectorAll('.dayh')];
        const hrs=inputs.map(i=>parseFloat(i.value||'0')||0);
        const {weeklyHoliday, weeklyStd, monthlyStd} = weeklyCalc(hrs);

        // 금액 계산
        const minGross = monthlyStd * minWage;
        const minRes = computeFromGross(minGross, 0); // 비과세 0 가정
        const contGross = monthlyStd * contractWage;
        const contRes = computeFromGross(contGross, 0);
        const contFromNet = computeFromNet(contRes.net, 0); // (2) 실수령 기준 역산 세전

        const tr = document.createElement('tr');
        tr.innerHTML =
          buildCellC(`근로시간 ${idx+1}안`) +
          hrs.map(h=>buildCellC(h.toFixed(1))).join('') +
          buildCellC(weeklyHoliday.toFixed(1)) +
          buildCellC(weeklyStd.toFixed(1)) +
          buildCellC(monthlyStd.toString()) +
          buildCell(fmt(minGross)) +
          buildCell(fmt(minRes.net)) +
          buildCell(fmt(contGross)) +
          buildCell(fmt(contRes.net)) +
          buildCell(fmt(contFromNet.gross)); // 실수령 기준 역산 세전
        mwTbody.appendChild(tr);
      });
    });
  </script>
</body>
</html>
